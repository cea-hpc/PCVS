#!/bin/sh

REQUIRE_OPENMP=true
OMP_THREAD_LIST="2 4 8"
MPI_THREAD_LIST="8"
MPI_NODE_NB="2 4"
COMMAND_OPTIONS="-laplace -P 2 2 2 -n 150 150 150 -solver "

cp -r ${PCVS_CSOURCE_DIR}/* ${PCVS_CWORK_DIR}
common_insert_test "compile_mpc_AMG2013May20" "0" "make -C ${PCVS_CWORK_DIR}/src"

for solver in "1" "2" "3"
do
for net in ${MPC_NET_LIST}
do
	for thread in ${MPC_THREAD_LIST}
	do
		for mpi_thread in ${MPI_THREAD_LIST}
		do
		    for mpi_node in ${MPI_NODE_NB}
		    do
            nb_core="${CLUSTER_MAX_CORES_PER_NODE}"
			if test ${mpi_thread} -eq 1;
			then 
				proc="-p=1"
				node="-N=1"
			else
				proc="-p=4"
				node="-N=${mpi_node}"
                if test "${mpi_node}" = "2" ; then
                    nb_core="`echo ${CLUSTER_MAX_CORES_PER_NODE} / 2 | bc `"
                fi
			fi
			opts="--profiling=xml,stdout --clean --autokill=${autokill_timeout} ${node} ${proc} -n=${mpi_thread} --share-node -net=${net} -m=${thread} -c=${nb_core}"
			command="OMP_NUM_THREADS=0 ${MPCRUN} ${opts} ${MPCRUN_ARGS} ${PCVS_CWORK_DIR}/src/test/amg2013 ${COMMAND_OPTIONS} $solver"
			common_insert_test "test_mpc_AMG2013May20_${net}_${thread}_mpi_task_${mpi_thread}" "${EXPECTED_EXIT_CODE}" "$command" "compile_mpc_AMG2013May20"
		    done
		done
	done
done
done
