#!/bin/sh
############################# MPC License ##############################
# Wed Nov 19 15:19:19 CET 2008                                         #
# Copyright or (C) or Copr. Commissariat a l'Energie Atomique          #
#                                                                      #
# IDDN.FR.001.230040.000.S.P.2007.000.10000                            #
# This file is part of the MPC Runtime.                                #
#                                                                      #
# This software is governed by the CeCILL-C license under French law   #
# and abiding by the rules of distribution of free software.  You can  #
# use, modify and/ or redistribute the software under the terms of     #
# the CeCILL-C license as circulated by CEA, CNRS and INRIA at the     #
# following URL http://www.cecill.info.                                #
#                                                                      #
# The fact that you are presently reading this means that you have     #
# had knowledge of the CeCILL-C license and that you accept its        #
# terms.                                                               #
#                                                                      #
# Authors:                                                             #
#   - ADAM Julien julien.adam@cea.fr                                   #
#                                                                      #
########################################################################

#################### SOURCES FILES ######################
. ${PCVS_SOURCE_DIR}/build_scripts/common_functions.sh

################## LOAD CONFIG FILE #####################
. ${PCVS_SOURCE_DIR}/build_scripts/load_config.sh

#################### PARSE MPCRUN ARGS ##################
#capture interesting arguements of mpcrun line
MPCRUN_ARG_NB_PROCESS="1"
MPCRUN_ARG_NB_TASKS="1"
MPCRUN_ARG_NB_NODE=""

for arg in $*
do
	case ${arg} in
		-p=*)
			MPCRUN_ARG_NB_PROCESS=$(common_read_param_value "${arg}" -p)
			;;
		-n=*)
			MPCRUN_ARG_NB_TASKS=$(common_read_param_value "${arg}" -n)
			;;
		--nb-resources=*)
			MPCRUN_ARG_NB_NODE=$(common_read_param_value "${arg}" -N)
			;;
		--autokill=*)
			SALLOC_TIMEOUT="$(( $(common_read_param_value "$arg" --autokill) / 60 ))"
            		if [ "$SALLOC_TIMEOUT" = "0" ] ; then
                		SALLOC_TIMEOUT=1
            		fi
			;;
	esac
done

if [ -z "$LAUNCHER_COMMAND" ] ; then
	echo "ERROR : You have to provide your launcher command with LAUNCHER_COMMAND !!!"
	exit 1
fi

command="${LAUNCHER_COMMAND} -N 1 -c ${CLUSTER_MAX_CORES_PER_NODE} ${SLURM_SALLOC_OPTS} -T $SALLOC_TIMEOUT ${LAUNCHER_EXTRA_ARGS} $@"
echo "Launched from cea compil wrapper"
echo "${command}"
${command}
