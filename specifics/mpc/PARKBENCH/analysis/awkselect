#!/bin/nawk -f
#
#  To select particular raw results with given blocksize, filesize and key.
#  key: "w", "r"....

BEGIN {
	tmpfile = testname "_f" filesize "_b" blocksize;
	print "#testname",testname > tmpfile;
	print "#filesize",filesize >> tmpfile;
	print "#blocksize",blocksize >> tmpfile;
	print "#" >> tmpfile;
	fsize = filesize*1000000;
	bsize = blocksize*1000000;
	gotdate = 0;
}

  (($1 == "start")&&(gotdate == 0)){
  date = $2;
  gotdate = 1;
}
 
  (($1 == "##")&&($2 == "Test")&&($3 == "input")&&($4 == "arguments")){
  testOn = 0;
}

  (($1 == "##")&&($2 == "Test")&&($3 == "output")&&($4 == "information")){
  fsizeOn = 0;
  bsizeOn = 0;
}

  ("nprocs" == $1){
  nprocs = $2;
}

  (("testname" == $1)&&(testname == $2)){
  testOn = 1;
}

  (("filesize" == $1)&&(fsize == $2)){
  fsizeOn = 1;
}

  (("blocksize" == $1)&&(bsize == $2)){
  bsizeOn = 1;
}

  ((testOn == 1)&&(fsizeOn == 1)&&(bsizeOn == 1)&&($1 == key)){
  tnprocs = nprocs;
  if (tnprocs == 1)  print $2 >> tmpfile;
  if (tnprocs == 2)  print $2,$3 >> tmpfile;
  if (tnprocs == 3)  print $2,$3,$4 >> tmpfile;
  if (tnprocs == 4)  print $2,$3,$4,$5 >> tmpfile;
}	

END{
	gnucommandfile = testname ".gnucmd";
	print "set data style linespoints" > gnucommandfile;
	print "set autoscale x" >> gnucommandfile;
	print "set nokey" >> gnucommandfile;
	print "set terminal postscript" >> gnucommandfile;
     # Should be careful about string length, max 50 for gnuplot
	printf("set output \"%s.ps\"\n", testname) >> gnucommandfile;
	printf("set xlabel \"Loop counter\"\n") >> gnucommandfile;
	printf("set ylabel \"Timings (sec)\"\n") >> gnucommandfile;
	if (tnprocs == 1) {
	  printf("set title \"%s test,   key: %s,   filesize %3.1f MB, blocksize %3.2f MB    %d\"\n", testname,key,filesize,blocksize,date) >> gnucommandfile;
	  printf("plot '< tail +5 \"%s\"'\n",tmpfile) >> gnucommandfile;
	}
	if (tnprocs == 2) {
	  printf("set title \"%s test,  proc 1,  key: %s,   filesize %3.1f MB, blocksize %3.2f MB    %d\"\n", testname,key,filesize,blocksize,date) >> gnucommandfile;
	  printf("plot '< tail +5 \"%s\"' using 0:1 \n",tmpfile) >> gnucommandfile;
	  printf("set title \"%s test,  proc 2,  key: %s,   filesize %3.1f MB, blocksize %3.2f MB    %d\"\n", testname,key,filesize,blocksize,date) >> gnucommandfile;
	  printf("plot '< tail +5 \"%s\"' using 0:2 \n",tmpfile) >> gnucommandfile;
	}
	close(gnucommandfile);
	system("gnuplot " gnucommandfile);
#	system ("rm -f " datafile);
}


